<!doctype html>
<head>
    <title>{% block title %}{% endblock %}BookBeats</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap" rel="stylesheet">

</head>

<body>
    <div class="full-body-container">
        <div class="top-text">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/BookBeatsLogo.png') }}">
            </div>
            <p>Create a playlist to listen to while you read</p>
            <div class="input-box" onclick="sendFocus()">
                <label for="book-search">Find Your Book</label>
                <input name='book-search' placeholder="Search for a book title (eg: 'The Great Gatsby')" id="filter-text-val">
            </div>
            <!-- Display book title suggestions -->
            <div class="suggestions">
                <ul id="title-suggestions"></ul>
            </div>
            <!-- Search button -->
            <div class="search">
                <button onclick="filterText()">Give Me a Playlist!</button>
            </div>
            <!-- Display error message if book title not found -->
            <div id="error-message" class="error-message" style="display: none;">Book Title Not Found</div>
        </div>
        <div id="answer-box"></div>
    </div>

    <script>
        // Add an input event listener to the book search input field
        document.getElementById("filter-text-val").addEventListener("input", function() {
        const inputText = this.value.trim();
        if (inputText) {
            fetchBookTitles(inputText);
        } else {
            // Clear the suggestions if the input is empty
            clearBookSuggestions();
            // Hide the error message if the input box is empty
            document.getElementById("error-message").style.display = "none";
        }
    });

        function fetchBookTitles(query) {
            fetch(`/book-titles?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    const titleList = document.getElementById("title-suggestions");
                    titleList.innerHTML = "";
                    // Display only a limited number of suggestions (e.g., 10)
                    const maxSuggestions = 10;
                    for (let i = 0; i < Math.min(data.length, maxSuggestions); i++) {
                        const listItem = document.createElement("li");
                        listItem.textContent = data[i];
                        titleList.appendChild(listItem);
                    }
                })
                .catch(error => {
                    console.error('Error fetching book titles:', error);
                });
        }

        function clearBookSuggestions() {
            const titleList = document.getElementById("title-suggestions");
            titleList.innerHTML = "";
        }

        function answerBoxTemplate(title, artist, spotifyId, genres) {
            return `<div class='song-container' data-spotify-id='${spotifyId}'>
                <div class='song-details'>
                    <div class='details-gen'>
                        <h3 class='song-title'>${title}</h3>
                        <p class='song-artist'>${artist}</p>
                    </div
                    <div class='song-genres'>
                        <!-- Display genres -->
                        <p class='song-genres'>Genres: ${genres.join(', ')}</p>
                    </div>
                
                <div class='audio-player'>
                    <iframe src="https://open.spotify.com/embed/track/${spotifyId}" width="560" height="160px" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                </div>
                
                <!-- Returns album image citation -->
                <div class='album-image'></div>
                </div>     
            </div>`;
        }

        function filterText() {
    document.getElementById("answer-box").innerHTML = "";
    const titleInput = document.getElementById("filter-text-val").value;
    // Clear book suggestions
    clearBookSuggestions();
    fetch("/songs?title=" + titleInput)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 404) {
                // Book title not found, display error message
                document.getElementById("error-message").style.display = "block";
                throw new Error("Book title not found");
            } else {
                throw new Error("Server error");
            }
        })
        .then(data => {
            // Hide the error message if it was previously displayed
            document.getElementById("error-message").style.display = "none";

            // Process the response if the book title was found
            data.top_ten_songs.forEach(song => {
                const title = song.title;
                const artist = song.artist;
                const spotifyId = song.spotify_id;
                const genres = song.genres;
                let tempDiv = document.createElement("div");
                tempDiv.innerHTML = answerBoxTemplate(title, artist, spotifyId, genres);
                document.getElementById("answer-box").appendChild(tempDiv);

                // Fetch album image for each song
                fetchAlbumImage(spotifyId);
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

        function sendFocus() {
            document.getElementById('filter-text-val').focus();
        }

        function fetchAlbumImage(spotifyId) {
            fetch(`/album-cover/${spotifyId}`)
                .then(response => response.text())
                .then(albumCoverUrl => {
                    const songContainer = document.querySelector(`[data-spotify-id='${spotifyId}']`);
                    if (songContainer) {
                        const albumImageContainer = songContainer.querySelector('.album-image');
                        albumImageContainer.innerHTML = `<a href="${albumCoverUrl}">Image Source</a>`;
                        // albumImageContainer.innerHTML = `<img src="${albumCoverUrl}" alt="Album Image">`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching album image:', error);
                });
        }
    </script>
</body>
